<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google AI Studio - Replica</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --sidebar-bg: #f8f9fa;
            --border-color: #dadce0;
            --google-blue: #1a73e8;
            --text-main: #3c4043;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; display: flex; height: 100vh; color: var(--text-main); }
        
        /* Sidebar Izquierdo (System Instructions) */
        .sidebar { 
            width: 300px; border-right: 1px solid var(--border-color); 
            background: var(--sidebar-bg); padding: 20px; display: flex; flex-direction: column;
        }
        .sidebar h3 { font-size: 14px; text-transform: uppercase; color: #70757a; margin-bottom: 10px; }
        .system-box { 
            background: white; border: 1px solid var(--border-color); 
            border-radius: 8px; padding: 10px; height: 100%; font-size: 13px; overflow-y: auto;
            color: #555; line-height: 1.4;
        }

        /* Área Principal (Chat) */
        .main-content { flex: 1; display: flex; flex-direction: column; background: white; }
        .header { 
            padding: 15px 25px; border-bottom: 1px solid var(--border-color); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-container { flex: 1; padding: 20px 10%; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        
        /* Burbujas de Chat estilo AI Studio */
        .message { max-width: 85%; padding: 15px; border-radius: 12px; font-size: 15px; line-height: 1.6; }
        .user-msg { align-self: flex-end; background: #e8f0fe; border: 1px solid #d2e3fc; }
        .ai-msg { align-self: flex-start; background: white; border: 1px solid var(--border-color); }

        /* Input Inferior */
        .input-area { padding: 20px 10%; border-top: 1px solid var(--border-color); display: flex; gap: 10px; }
        textarea { 
            flex: 1; border: 1px solid var(--border-color); border-radius: 24px; 
            padding: 12px 20px; resize: none; height: 24px; font-family: inherit;
        }
        button { 
            background: var(--google-blue); color: white; border: none; 
            padding: 0 25px; border-radius: 24px; cursor: pointer; font-weight: bold;
        }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>System Instructions</h3>
        <div class="system-box">
            <strong>SaaS-Builder GPT: Chile Edition</strong><br><br>
            Experto en Micro-SaaS y arquitectura legal-tech enfocada en el mercado chileno. 
            Aplicando leyes 18.101, 19.496 y 21.461.
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div><strong>Gemini 2.0 Flash</strong> <small style="color: green;">● Online</small></div>
            <div>Créditos: <span id="creditos">--</span></div>
        </div>

        <div id="chat-container" class="chat-container">
            <div class="message ai-msg">Hola, soy tu socio técnico. ¿Qué contrato o idea de SaaS chileno quieres auditar hoy?</div>
        </div>

        <div class="input-area">
            <textarea id="userInput" placeholder="Escribe tu consulta o pega tu contrato aquí..."></textarea>
            <button id="sendBtn" onclick="enviar()">Run</button>
        </div>
    </div>

    <script>
        async function enviar() {
            const input = document.getElementById('userInput');
            const container = document.getElementById('chat-container');
            const btn = document.getElementById('sendBtn');
            const text = input.value.trim();

            if(!text) return;

            // Agregar mensaje usuario
            container.innerHTML += `<div class="message user-msg">${text}</div>`;
            input.value = '';
            btn.disabled = true;
            container.scrollTop = container.scrollHeight;

            try {
                const response = await fetch('/api/analizar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: "tu_correo@ejemplo.com", // Aquí podrías pedirlo al inicio
                        bases: "Consulta general", 
                        oferta: text 
                    })
                });

                const data = await response.json();
                
                // Agregar respuesta AI con formato Markdown
                const aiHtml = marked.parse(data.analisis);
                container.innerHTML += `<div class="message ai-msg">${aiHtml}</div>`;
                document.getElementById('creditos').innerText = data.creditosRestantes;
                
            } catch (err) {
                container.innerHTML += `<div class="message ai-msg" style="color:red;">Error de conexión.</div>`;
            } finally {
                btn.disabled = false;
                container.scrollTop = container.scrollHeight;
            }
        }
    </script>
</body>
</html>